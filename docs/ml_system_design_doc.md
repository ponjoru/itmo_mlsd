# ML System Design Document
Модуль Охраны Периметра MVP v1

## Описание задачи
Необходимо разработать программный модуль для системы видеонаблюдения, предназначенный для автоматического контроля различных охраняемых территорий - промышленных объектов, складов, частных владений, государственных зон и т.д. Модуль работает с видеопотоками от камер, установленных по периметру охраняемой территории, преимущественно в уличных условиях.

Цель модуля - в реальном времени обнаруживать факт проникновения в заранее определённую охраняемую зону, сформировать тревожное событие и оперативно уведомить службы безопасности для своевременного реагирования.

Программное обеспечение должно быть интегрировано в существующую систему видеонаблюдения и работать на доступных вычислительных ресурсах. Разработчики могут рекомендовать оптимальные варианты развёртывания инфраструктуры.

Модуль предполагается использовать в нерабочее время - пользователь может задавать расписание его работы. Когда модуль включён, он должен фиксировать и сигнализировать о любом появлении посторонних объектов в охраняемой зоне, при этом если в один и тот же момент присутствует несколько объектов, достаточно сформировать один тревожный сигнал.

Также в некоторых случаях камеры видимого спектра могут дублироваться тепловизорами; их синхронизация не требуется.

## Виды событий / нарушений
* **Подозрительное поведение  людей рядом с охраняемой зоной** <br>
  Видеосъемка, слишком долгое нахождение в кадре, подозрительные позы, скрытное передвижение
* **Пересечение людьми охраняемой зоны** <br>
  Шагом, бегом, перекатами, ползком и другими формами скрытного передвижения
* **Пересечение транспортного средства охраняемой зоны**


## Термины
**Целевой объект** - нарушитель охраняемого периметра: траснспортное средство (легковая машина, мотоцикл, велосипед, грузовик) или человек \
**RGB камера** - камера видимого спектра \
**IR (Infra-Red)** камера - тепловизор \
**Зона события (zROI)** - zone Region of Interest полигон, задаваемый для каждой камеры вручную при установке. Охраняемая зона, при попадании целевого объекта в которую, должна вызываться тревога
**Подозрительное поведение** - человек задерживается подозрительно долго около охраняемого объекта, ведет видеосъемку или фотосъемку местности, скрытное перемещение, попытка спрятаться \
**DORI стандарт** - стандарт для видеоаналитики [DORI stands for Detect, Observe, Recognise, Identify](https://wedosecurity.co.za/cctv-cameras/dori-standard/) \
**MP** - MegaPixels, единица измерения разрешения матрицы камеры \
**ТС** - скоращенное от Транспортное Средство \
**AMX** - Advanced Matrix Extensions, расширенные матричные инструкции процессоров Intel для эффективных матричных вычислений (для ускорения AI инференса) [ссылка на wiki](https://en.wikipedia.org/wiki/Advanced_Matrix_Extensions) \
**SLA** - Service Level Agreement, формальный договор между заказчиком услуги и ее поставщиком, содержащий описание услуги, права и обязанности сторон и, самое главное, согласованный уровень качества предоставления данной услуги \
**ПО** - Программное обеспечение \
**Confidence Threshold** - это минимальный уровень уверенности модели, при котором она считает свой результат достаточно надёжным, чтобы выдать его как ответ \
**MOT** - Multiple Object Tracking - задача треккинга нескольких объектов \

## 1. Цели и предпосылки
## 1.1 Зачем идем в разработку
* Нужно вовремя обнаружать и предотвращать проникновение на охраняемый периметр посторонних личностей
* Объект большой, камер много, сложно держать охране в фокусе все камеры без автоматизации

## 1.2 Бизнес требования и ограничения
**Ограничения:**
* Камеры: RGB + IR, 0.3-8MP
* сервера с CPU и AMX инструкциями. 80 камер, два сервера. (Можно обсуждать улучшение железа)
* Минимальные размеры людей: 50 пикселей на метр (по DORI)

**Функциональные требования:**
* Система должна уметь работать как с RGB, так и IR камерами
* Система должна уметь детектировать людей в кадре
* Система должна обнаружать людей в любой позе (скрытное перемещение, шаг, бег, кувырок)
* Система должна на одного нарушителя формировать одно событие
* Система должна обнаруживать факт входа в zROI человеком или ТС
* Система должна формировать событие при нарушении периметра
* В системе должна быть поддержка задания любого полигона zROI
* Система должна предоставить визуализацию события для подтверждения и проверки охраной (id камеры и снапшот)
* Система должна вести учет событий
* Система должна поддерживать добавление новых камер
* Система должна предупреждать отдельным событием об подозрительном поведении людей около зоны
* Модуль подозрительного поведения может быть отключен на некоторых камерах
* Система не должна реагировать на животных
* Модуль должен работать в любое время суток
* Систему можно отключать полностью в рабочее время

**Нефункциональные требования:**
* Recall целевых событий **>95%**
* Меньше **4 ложных тревог** на оператора за смену в одной локации
* Время на сработку тревоги **<5 секунд**
* Latency ML модуля должен обеспечивать выполнение SLA < 5 сек. Допустимое значение latency будет определено после построения baseline и измерений, но ориентир — **≤ 200–300 ms на детектор**
* Вес Mодели **≤ 150 MB**, inference **≤ 2 GB RAM** на один поток

**Бизнес метрики:**
* Time To Detect / Time To Response - время требуемое для сработки тревоги с момента появления целевого объекта в кадре
* True Alarm Rate (Recall) - отношение количества обнаруженных событий модулем к количеству всех целевых событий
* False Alarm Rate (Precision) - отношение количества ложных срабатываний к общему количеству срабатываний
* Затраты на сотрудников службы безопасности - зарплаты сотрудников, стоимость проверки событий
* Поддерживаемое количество камер на один сервер
* Время на настройку новой камеры (при добавлении новой камеры, физическая настройка камеры)
* Время на выкатку обновления (при добавлении новой камеры, обновление ПО/дообучение моделей, если нужно)

**Прокси метрики:**
* Object Detection
   * AP@50 - Average Precision при пороге IoU=0.5, не зависит от порога Confidence Threshold ([описание](https://cocodataset.org/#detection-eval))
   * F1@50 - F1 score с фиксированным порогом Confidence Threshold и IoU=0.5
* MOT
   * DetA ([описание](https://miguel-mendez-ai.com/2024/08/25/mot-tracking-metrics))
   * IDF1 ([описание](https://miguel-mendez-ai.com/2024/08/25/mot-tracking-metrics))

## 1.3. Что входит и что не входит в скоп проекта (первая стадия)
* Входит: обнаружение людей в зоне интереса
* Не входит: обнаружение ТС в зоне интереса
* Не входит: определение подозрительного поведения
* Не входит: распознавание на [4K кадрах](https://en.wikipedia.org/wiki/4K_resolution)

## 1.4. Предпосылки решения
* Большое количество камер (80+), просмотр вручную требует большого количества операторов
* Операторам тяжело ночами сидеть и мониторить обстановку
* Охрана часто игнорирует сигналы тревоги из-за слишком большого количества FP у текущего решения
* Текущее решение практически не находит события на тепловизорах
* Текущее решение неудовлетворительно обнаруживает нарушителей в нестандартных позах
* Нужно повышать доверие к системе со стороны охраны
* Текущий модуль не приспособлен для работы с камерами с большим фокусным расстоянием

## 2. Методология
### 2.1. Постановка задачи
**ML задача:** \
Object Detection + Multiple-Object Tracking (MOT) + Zone-based Event Detection \
(+ VideoAnalytics в будущем)

### 2.2. Блок-схема решения

### 2.2.1. Блок-схема решения с этапами разработки
<!-- ![Block Scheme](../assets/mlsd_solution_scheme.png) -->
<img src="../assets/mlsd_solution_scheme.png" width="1300">


### 2.2.2. Архитектура ML модуля
**Бейзлайн:**
* Классический подход detection (YOLOv11n) + tracker (ByteTrack) - основная работа на детекторе <br>
![Baseline](../assets/mlsd_baseline.png)

**MVPv1:**
* Детектор архитектурно оптимизированный под CPU инференс
* Tracking First - детектор срабатывает реже, вся работа на треккере
* Smart ROI selection - для повышения Recall на маленьких объектах бьем на тайлы входной кадр с разным разрешением вдали и вблизи  <br>
![MVPv1](../assets/mlsd_mvp_scheme.png)

### 2.2.3. Архитектура MLOps
![MLOps](../assets/mlsd_mlops_scheme.png)
1. **Data Preparation** <br>
   Open Source датасеты, Data Mining, Разметка и авторазметка, Dataset Verification, Версионирование, Разделение на train, val и test. Сохранение датасетов в `Dataset Registry`
2. **Train Models** <br>
   Обучение, Валидация, Выбор лучшего чекпоинта, Сохранение логов и весов в `Artefact Registry`, Воспроизводимость, Distributed Training, Оптимизация Гиперпараметров
3. **Implement Simple Python Inference Module** <br>
   Реализация простого python инференса для оценки точности модуля до всех оптимизаций
4. **Offline Testing (E2E Pipeline Python)** <br>
   Тестирование e2e и stage-wise Python пайплайна (отдельно детектор, отдельно треккинг и тд) на архивных данных (тестовом датасете). Сохранение метрик в `Leaderboard`
5. **Models Optimisation** <br>
   Конвертация в inference engine для CPU инференса, квантизация, прунинг (опционально), дистиляция (опционально). Сохранение модели в `Artefact Registry`
6. **Implement C++ Inference Module** <br>
   Реализация C++ кода инференса для встраивания в прод. Сборка билда, сохранение билда в `Build Registry`
7. **Offline Testing (E2E Pipeline C++)** <br>
   Тестирование e2e и stage-wise C++ пайплайна (отдельно детектор, отдельно треккинг и тд) на архивных данных (тестовом датасете). Тот же код, что и для **шага 4**. Сохранение метрик в `Leaderboard`
8. **Deployment** <br>
   Деплой модуля на целевое железо. Настройка камер
9. **Online Testing Shadow Deployment** <br>
   Онлайн тестирование модуля. Shadow Deployment (на одних и тех же данных гоняем старую версию и новую версию, оцениваем разницу). Использование инстуремнтов из A/B тестирования для статзначимой оценки качества. Ручная валидация результатов.
10. **Monitoring** <br>
   Data drift detection, model drift detection. Логирование статистик, метрик использования ресурсов в `Logs Dashboards`. Отбор потенциально полезных данных полуавтоматически или на основе ***Human In The Loop*** для будущих обучений и тестов.
11. **Setup CI/CD/CT (Опционально)** <br>
   Настройка Continuous Integration, Continuous Delivery, Continuous Training. Настройка триггера переобучения модели. Автообучение модели. Оптимизация процессов.
